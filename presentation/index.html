<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Refactoring legacy code using functional programming</title>

    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/moon.css"> 

    <!-- Theme used for syntax highlighting of code -->
    <!--<link rel="stylesheet" href="lib/css/solarized-dark.css"> -->
    <link rel="stylesheet" href="lib/css/solarized-light.css">

    <!-- Printing and PDF exports -->
    <script>
      var link = document.createElement( 'link' );
link.rel = 'stylesheet';
link.type = 'text/css';
link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>
  </head>
  <body>
    <div class="reveal">
      <div class="slides">
        <section>
          <h2>Refactoring legacy code using functional programming</h2>
          <p>Sebastián Estrella</p>
        </section>

        <section>
          <h3>About me</h3>
          <p>TODO</p>
        </section>

        <section>
          <h1>Showtime</h1>
        </section>

        <section>
          <section>
            <h3>Original Code Snippet</h3>
            <pre>
              <code class="java" data-trim>
                Table table = new Table();

                for (User user : users) {
                  if (user.isEnabled()) {
                    Row row = new Row();
                    row.addColumn(new Column(user.fullName());
                    String role = user.isAdmin() ? "Admin" : "Member";
                    row.addColumn(new Column(role));
                    table.addRow(row);
                  }
                }

                table.render();
              </code>
            </pre>
          </section>

          <section>
            <h3>The Magical Number Seven, Plus or Minus Two</h3>
            <p>George Armitage Miller</p>
          </section>

          <section>
            <h3>Separation of Concerns</h3>
            <pre>
              <code class="java" data-trim data-line-numbers="3-8">
                Table table = new Table();

                List&lt;User&gt; enabledUsers = new ArrayList&lt;User&gt;();
                for (User user : users) {
                  if (user.isEnabled()) {
                    enabledUsers.add(user);
                  }
                }

                for (User user : enabledUsers) {
                  Row row = new Row();
                  row.addColumn(new Column(user.fullName());
                  String role = user.isAdmin() ? "Admin" : "Member";
                  row.addColumn(new Column(role));
                  table.addRow(row);
                }

                table.render();
              </code>
            </pre>
          </section>

          <section>
            <h3>One Row per User</h3>
            <pre>
              <code class="java" data-trim data-line-numbers="8-15">
                List&lt;User&gt; enabledUsers = new ArrayList&lt;User&gt;();
                for (User user : users) {
                  if (user.isEnabled()) {
                    enabledUsers.add(user);
                  }
                }

                List&lt;Row&gt; rows = new ArrayList&lt;Row&gt;();
                for (User user : enabledUsers) {
                  Row row = new Row();
                  row.addColumn(new Column(user.fullName());
                  String role = user.isAdmin() ? "Admin" : "Member";
                  row.addColumn(new Column(role));
                  rows.add(row);
                }

                Table table = new Table();
                table.addRows(rows);
                table.render();
              </code>
            </pre>
          </section>

          <section>
            <h3>Advantages?</h3>
            <ul>
              <li>Cohesion</li>
              <li>Readability</li>
              <li>Testability</li>
            </ul>
          </section>
        </section>

        <section>
          <section>
            <h1>Refactoring JDK 8+</h1>
          </section>

          <section>
            <h3>Functional Programming</h3>
            <ul>
              <li>First-class functions</li>
              <li>Higher-order functions</li>
              <li>Composition</li>
            </ul>
          </section>

          <section>
            <h3>Wholemeal programming</h3>
            <p>TODO</p>
          </section>

          <section>
            <h3>Filter</h3>
            <pre>
              <code class="java" data-trim>
                List&lt;User&gt; enabledUsers = new ArrayList&lt;User&gt;();
                for (User user : users) {
                  if (user.isEnabled()) {
                    enabledUsers.add(user);
                  }
                }
              </code>
            </pre>
            <pre>
              <code class="java" data-trim>
                List&lt;User&gt; enabledUsers = users.stream()
                  .filter(user -> user.isEnabled())
                  .collect(Collectors.toList());
              </code>
            </pre>
          </section>

          <section>
            <h3>Map</h3>
            <pre>
              <code class="java" data-trim>
                List&lt;Row&gt; rows = new ArrayList&lt;Row&gt;();
                for (User user : enabledUsers) {
                  Row row = new Row();
                  row.addColumn(new Column(user.fullName());
                  String role = user.isAdmin() ? "Admin" : "Member";
                  row.addColumn(new Column(role));
                  rows.add(row);
                }
              </code>
            </pre>
            <pre>
              <code class="java" data-trim>
                List&lt;Row&gt; rows = enabledUsers.stream()
                  .map(user -> {
                    Row row = new Row();
                    row.addColumn(new Column(user.fullName());
                    String role = user.isAdmin() ? "Admin" : "Member";
                    row.addColumn(new Column(role));
                    rows.add(row);
                  })
                  .collect(Collectors.toList());
              </code>
            </pre>
          </section>

          <section>
            <h3>Composition</h3>
            <pre>
              <code class="java" data-trim>
                List&lt;User&gt; enabledUsers = users.stream()
                  .filter(user -> user.isEnabled())
                  .map(user -> {
                    Row row = new Row();
                    row.addColumn(new Column(user.fullName());
                    String role = user.isAdmin() ? "Admin" : "Member";
                    row.addColumn(new Column(role));
                    rows.add(row);
                  })
                  .collect(Collectors.toList());

                Table table = new Table();
                table.addRows(rows);
                table.render();
              </code>
            </pre>
          </section>
        </section>

        <section>
          <section>
            <h1>Refactoring Legacy Code</h1>
          </section>

          <section>
            <h3>JDK 5, 6, 7 - Missing pieces</h3>
            <ul>
              <li>lambdas</li>
              <li>first-class functions</li>
              <li>high order functions</li>
            </ul>
          </section>

          <section>
            <h3>JDK 5, 6, 7 - What we have</h3>
            <ul>
              <li>Anonymous classes</li>
              <li>Generics</li>
            </ul>
          </section>

          <section>
            <h3>Swing - Anonymous Classes</h3>
            <pre>
              <code class="java" data-trim>
                JButton submitButton = new JButton("Submit");
                submitButton.addActionListener(new ActionListener() {
                  @Override
                  public void actionPerformed(ActionEvent e) {
                    // Do something
                  }
                });
              </code>
            </pre>
          </section>

          <section>
            <h3>Legacy Filter - Before</h3>
            <pre>
              <code class="java" data-trim>
                interface Filter&lt;A&gt; {
                  boolean filter(A element);
                }

                &lt;A&gt; List&lt;A&gt; filter(Filter&lt;A&gt; predicate, List&lt;A&gt; list) {
                  List&lt;A&gt; result = new ArrayList&lt;A&gt;();
                  for (A element : list) {
                    if (predicate.filter(element)) {
                      result.add(element);
                    }
                  }
                  return result;
                }
              </code>
            </pre>
          </section>

          <section>
            <h3>Legacy Filter - After</h3>
            <pre>
              <code class="java" data-trim>
                List&lt;User&gt; enabledUsers = filter(new Filter&lt;User&gt;() {
                  @Override
                  public boolean filter(User user) {
                    return user.isEnabled();
                  }
                }, users);
              </code>
            </pre>
          </section>

          <section>
            <h3>Legacy Map - Before</h3>
            <pre>
              <code class="java" data-trim>
                interface Mapper&lt;A, B&gt; {
                  B map(A element);
                }

                &lt;A, B&gt; List&lt;B&gt; map(Mapper&lt;A, B&gt; mapper, List&lt;A&gt; list) {
                  List&lt;B&gt; result = new ArrayList&lt;B&gt;();
                  for (A element : list) {
                    result.add(mapper.map(element));
                  }
                  return result;
                }
              </code>
            </pre>
          </section>

          <section>
            <h3>Legacy Map - After</h3>
            <pre>
              <code class="java" data-trim>
                List&lt;Row&gt; rows = map(new Mapper&lt;User, Row&gt;() {
                  @Override
                  public Row map(User user) {
                    Row row = new Row();
                    row.addColumn(new Column(user.fullName());
                    String role = user.isAdmin() ? "Admin" : "Member";
                    row.addColumn(new Column(role));
                    return row;
                  })
                }, enabledUsers);
              </code>
            </pre>
          </section>

          <section>
            <h3>Legacy Filter + Map</h3>
            <pre>
              <code class="java" data-trim>
                List&lt;Row&gt; rows = map(new Mapper&lt;User, Row&gt;() {
                  @Override
                  public Row map(User user) {
                    Row row = new Row();
                    row.addColumn(new Column(user.fullName());
                    String role = user.isAdmin() ? "Admin" : "Member";
                    row.addColumn(new Column(role));
                    return row;
                  })
                }, filter(new Filter&lt;User&gt;() {
                  @Override
                  public boolean filter(User user) {
                    return user.isEnabled();
                  })
                }, users));
              </code>
            </pre>
          </section>
        </section>

        <section>
          <section>
            <h1>Common abstractions</h1>
          </section>

          <section>
            <pre>
              <code class="java" data-trim>
                interface Filter&lt;A&gt; {
                  boolean filer(A element);
                }

                interface Mapper&lt;A, B&gt; {
                  B map(A element);
                }
              </code>
            </pre>
          </section>

          <section>
            <h3>The Function abstraction</h3>
            <pre>
              <code class="java" data-trim>
                interface F&lt;A, B&gt; {
                  B apply(A element);
                }
              </code>
            </pre>
          </section>

          <section>
            <h3>The Function abstraction - Refactor Predicate</h3>
            <pre>
              <code class="java" data-trim>
                interface Predicate&lt;A&gt; extends F&lt;A, Boolean&gt;
              </code>
            </pre>
          </section>
        </section>

        <section>
          <section>
            <h1>Generated Bytecode</h1>
          </section>

          <section>
            <h3>Are these two code snippets equivalent?</h3>
            <pre>
              <code class="java" data-trim>
                public int[] filterEven(int[] numbers) {
                  IntPredicate isEven = x -> x % 2 == 0;
                  return Arrays.stream(numbers).filter(isEven).toArray();
                }
              </code>
            </pre>
            <pre>
              <code class="java" data-trim>
                public int[] filterEven(int[] numbers) {
                  IntPredicate isEven = new IntPredicate() {
                    public boolean test(int x) {
                      return x % 2 == 0;
                    }
                  };
                  return Arrays.stream(numbers).filter(isEven).toArray();
                }
              </code>
            </pre>
          </section>

          <section>
            javap output
          </section>

          <section>
            Benchmark                          Mode  Cnt        Score        Error  Units
            FilterBenchmark.anonymousClass    thrpt   25  3905620.807 ±  97753.350  ops/s
            FilterBenchmark.lambdaExpression  thrpt   25  3940706.986 ± 136971.008  ops/s
          </section>

          <section>
            invoke dynamic explain
          </section>
        </section>

        <section>
          <h1>Q&A</h1>
        </section>

        <section>
          <h1>Thank you!</h1>
        </section>
      </div>
    </div>

    <script src="js/reveal.js"></script>

    <script>
      // More info about config & dependencies:
      // - https://github.com/hakimel/reveal.js#configuration
      // - https://github.com/hakimel/reveal.js#dependencies
      Reveal.initialize({
        dependencies: [
          { src: 'plugin/markdown/marked.js' },
          { src: 'plugin/markdown/markdown.js' },
          { src: 'plugin/notes/notes.js', async: true },
          { src: 'plugin/highlight/highlight.js', async: true }
        ]
      });
    </script>
  </body>
</html>
